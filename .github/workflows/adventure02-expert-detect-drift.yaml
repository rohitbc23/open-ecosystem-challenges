# ============================================================================
# Infrastructure Drift Detection Workflow
# ============================================================================
# Detects infrastructure drift by running tofu plan and creates a PR if
# drift is found.
# ============================================================================

name: ðŸŒ†ðŸ”´ | Detect Infrastructure Drift (Adventure 02 - Expert)
on:
  workflow_dispatch:

# Ensure only one drift detection runs at a time
concurrency:
  group: drift-detection
  cancel-in-progress: false

env:
  WORKING_DIR: adventures/02-building-cloudhaven/expert
  TOFU_VERSION: "1.11.4"
  # This is only needed because we're using a mock GCS backend. In production, you'd remove this.
  # The actual value is set during startup.
  STORAGE_EMULATOR_HOST: "__GCP_MOCK_ENDPOINT__"

jobs:
  detect-drift:
    name: ðŸ” Detect Infrastructure Drift
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: write      # Required to create branch and commit drift log.
      pull-requests: write # Required to create PR.

    steps:
      # ----------------------------------------------------------------------
      # Setup
      # ----------------------------------------------------------------------
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.TOFU_VERSION }}
          tofu_wrapper: false

      # ----------------------------------------------------------------------
      # Initialize and Plan
      # ----------------------------------------------------------------------
      - name: ðŸ“¦ Initialize OpenTofu
        working-directory: ${{ env.WORKING_DIR }}
        run: tofu init

      - name: ðŸ“ Run OpenTofu Plan
        id: plan
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "drift=false" >> $GITHUB_OUTPUT

      # ----------------------------------------------------------------------
      # Generate Drift Log Entry (only if drift detected)
      # ----------------------------------------------------------------------
      - name: ðŸ“ Create drift log entry
        if: steps.plan.outputs.drift == 'true'
        working-directory: ${{ env.WORKING_DIR }}
        env:
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          RUN_NUMBER: ${{ github.run_number }}
          TRIGGER: ${{ github.event_name }}
        run: |
          LOG_DIR="drift-log"

          mkdir -p "$LOG_DIR"
          FILENAME="$LOG_DIR/$(date -u +%Y%m%d-%H%M%S).md"
          PLAN=$(tofu show tfplan -no-color)

          {
            echo "# Drift Detected"
            echo ""
            echo "- **Run:** [#${RUN_NUMBER}](${RUN_URL})"
            echo "- **Trigger:** ${TRIGGER}"
            echo ""
            echo "## Detected Drift"
            echo ""
            echo '```'
            echo "$PLAN"
            echo '```'
            echo ""
            echo "---"
            echo "*Auto-generated by drift detection workflow*"
          } > "$FILENAME"

      # ----------------------------------------------------------------------
      # Create PR (if drift detected)
      # ----------------------------------------------------------------------
      - name: ðŸ”€ Create Pull Request
        id: create-pr
        if: steps.plan.outputs.drift == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          draft: always-true # See https://github.com/peter-evans/create-pull-request/blob/main/docs/concepts-guidelines.md#workarounds-to-trigger-further-workflow-runs
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "fix: reconcile infrastructure drift"
          title: "ðŸš¨ Infrastructure Drift Detected"
          body: |
            ## ðŸš¨ Infrastructure Drift Detected

            Drift was detected in the CloudHaven infrastructure.
            Review the changes below and merge this PR to reconcile.

            ðŸ“‹ See the drift log entry for details.

            ---
            *Generated automatically by drift detection workflow*
          branch: fix/drift-${{ github.run_number }}
          delete-branch: true
          add-paths: |
            ${{ env.WORKING_DIR }}/drift-log/*.md
          labels: |
            drift
            infrastructure
            automated

      # ----------------------------------------------------------------------
      # Summary
      # ----------------------------------------------------------------------
      - name: ðŸ“ Job Summary
        run: |
          echo "## ðŸ” Drift Detection Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.plan.outputs.drift }}" == "false" ]; then
            echo "âœ… **No drift detected**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Infrastructure matches the desired state. Nothing to do!" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸš¨ **Drift detected**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Infrastructure has drifted from the desired state. A PR has been created to reconcile." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“‹ Pull Request" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”— [PR #${{ steps.create-pr.outputs.pull-request-number }}](${{ steps.create-pr.outputs.pull-request-url }})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸš€ Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. Review the PR and the drift log entry" >> $GITHUB_STEP_SUMMARY
            echo "2. Click **Ready for review** to trigger validation ([why?](https://github.com/peter-evans/create-pull-request/blob/main/docs/concepts-guidelines.md#triggering-further-workflow-runs))" >> $GITHUB_STEP_SUMMARY
            echo "3. Merge to apply changes with \`tofu apply\`" >> $GITHUB_STEP_SUMMARY
          fi