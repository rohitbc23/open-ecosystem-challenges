# ============================================================================
# Apply Workflow
# ============================================================================
# This workflow runs when a PR is merged to main.
# It applies the OpenTofu configuration to reconcile the infrastructure.
#
# Trigger: PR merged to main branch
#
# Note: In production, triggering on `push` to main with proper branch
# protection rules (requiring PRs) is simpler. We use `pull_request: closed`
# here because post-start.sh commits URL updates directly to main, which
# would trigger unwanted applies.
# ============================================================================

name: ðŸŒ†ðŸ”´ | Apply Infrastructure (Adventure 02 - Expert)

on:
  pull_request:
    types: [closed]
    branches: [main]
    paths:
      - "adventures/02-building-cloudhaven/expert/**"
      - ".github/workflows/adventure02-expert-*.yaml"

# Ensure only one apply runs at a time
concurrency:
  group: apply-infrastructure
  cancel-in-progress: false

env:
  WORKING_DIR: adventures/02-building-cloudhaven/expert
  TOFU_VERSION: "1.11.4"
  # This is only needed because we're using a mock GCS backend. In production, you'd remove this.
  # The actual value is set during startup.
  STORAGE_EMULATOR_HOST: "__GCP_MOCK_ENDPOINT__"

jobs:
  apply:
    name: ðŸš€ Apply Infrastructure Changes
    runs-on: ubuntu-latest
    timeout-minutes: 10

    # Only run if the PR was merged (not just closed)
    if: github.event.pull_request.merged == true

    permissions:
      actions: read        # Required to identify workflow run.
      checks: write        # Required to add status summary.
      contents: read       # Required to checkout repository.

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.TOFU_VERSION }}
          tofu_wrapper: false

      - name: ðŸš€ Apply
        uses: OP5dev/TF-via-PR@v13
        with:
          working-directory: ${{ env.WORKING_DIR }}
          command: plan
          tool: tofu
          format: true
          validate: true
          comment-pr: never
