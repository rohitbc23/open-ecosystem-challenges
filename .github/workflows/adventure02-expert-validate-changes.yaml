# ============================================================================
# OpenTofu Validation Workflow
# ============================================================================
# Runs on pull requests to validate OpenTofu changes.
# ============================================================================

name: ğŸŒ†ğŸ”´ | Validate Infrastructure Changes (Adventure 02 - Expert)

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review
    paths:
      - "adventures/02-building-cloudhaven/expert/**"
      - ".github/workflows/adventure02-expert-*.yaml"

concurrency:
  group: pr-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  WORKING_DIR: adventures/02-building-cloudhaven/expert
  TOFU_VERSION: "1.11.4"
  # This is only needed because we're using a mock GCS backend. In production, you'd remove this.
  # The actual value is set during startup.
  STORAGE_EMULATOR_HOST: "__GCP_MOCK_ENDPOINT__"

jobs:
  # ----------------------------------------------------------------------------
  # Validate & Plan
  # ----------------------------------------------------------------------------
  validate-and-plan:
    name: ğŸ“‹ Validate & Plan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      actions: read        # Required to identify workflow run.
      checks: write        # Required to add status summary.
      contents: read       # Required to checkout repository.
      pull-requests: write # Required to add PR comment.

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.TOFU_VERSION }}
          tofu_wrapper: false

      - name: ğŸ” Validate & Plan
        uses: OP5dev/TF-via-PR@v13
        with:
          working-directory: ${{ env.WORKING_DIR }}
          command: plan
          arg-lock: false
          tool: tofu
          format: true
          validate: true
          expand-diff: true
          expand-summary: false

  # ----------------------------------------------------------------------------
  # Test
  # Note: The GCP API mock container exposes port 8080
  # ----------------------------------------------------------------------------
  test:
    name: ğŸ§ª Test
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read

    services:
      gcp-api-mock:
        image: ghcr.io/katharinasick/gcp-api-mock:v1.1.4

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.TOFU_VERSION }}
          tofu_wrapper: false

      - name: ğŸ“¦ Initialize OpenTofu
        working-directory: ${{ env.WORKING_DIR }}
        run: tofu init -backend=false

      - name: ğŸ§ª Run tests
        working-directory: ${{ env.WORKING_DIR }}
        run: tofu test

  # ----------------------------------------------------------------------------
  # Security Scan
  # ----------------------------------------------------------------------------
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 5

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”’ Scan for Vulnerabilities
        uses: aquasecurity/trivy-action@0.33.1

      - name: ğŸ“Š Count Vulnerabilities
        id: count
        run: |
          count_severity() {
            jq "[.Results[]?.Misconfigurations[]? | select(.Severity==\"$1\")] | length" "$2" 2>/dev/null || echo 0
          }
          
          echo "critical=$(count_severity CRITICAL vulnerabilities.json)" >> $GITHUB_OUTPUT
          echo "high=$(count_severity HIGH vulnerabilities.json)" >> $GITHUB_OUTPUT
          echo "medium=$(count_severity MEDIUM vulnerabilities.json)" >> $GITHUB_OUTPUT
          echo "low=$(count_severity LOW vulnerabilities.json)" >> $GITHUB_OUTPUT
          echo "unknown=$(count_severity UNKNOWN vulnerabilities.json)" >> $GITHUB_OUTPUT
          
          # Generate details list (sorted by severity with emojis)
          details=$(jq -r '
            def severity_order: if . == "CRITICAL" then 0 elif . == "HIGH" then 1 elif . == "MEDIUM" then 2 elif . == "LOW" then 3 else 4 end;
            def severity_emoji: if . == "CRITICAL" then "ğŸ”´" elif . == "HIGH" then "ğŸŸ " elif . == "MEDIUM" then "ğŸŸ¡" elif . == "LOW" then "ğŸŸ¢" else "âšª" end;
            [.Results[]?.Misconfigurations[]?] | sort_by(.Severity | severity_order) | .[] | "| \(.Severity | severity_emoji) \(.Severity) | \(.ID) | \(.Title) |"
          ' vulnerabilities.json 2>/dev/null || echo "")
          echo "details<<EOF" >> $GITHUB_OUTPUT
          echo "$details" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸ’¬ Comment on PR
        uses: actions/github-script@v8
        with:
          script: |
            const body = `## ğŸ”’ Security Scan Results
            
            Trivy scanned your infrastructure code for potential security issues.
            
            | Severity | Count |
            |----------|-------|
            | ğŸ”´ Critical | ${{ steps.count.outputs.critical }} |
            | ğŸŸ  High | ${{ steps.count.outputs.high }} |
            | ğŸŸ¡ Medium | ${{ steps.count.outputs.medium }} |
            | ğŸŸ¢ Low | ${{ steps.count.outputs.low }} |
            | âšª Unknown | ${{ steps.count.outputs.unknown }} |
            
            > âš ï¸ Critical and High vulnerabilities must be resolved before merging.
            
            <details>
            <summary>ğŸ“‹ View Vulnerabilities</summary>
            
            | Severity | ID | Title |
            |----------|-----|-------|
            ${{ steps.count.outputs.details }}
            
            </details>`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: ğŸš« Fail on Blocking Vulnerabilities
        run: echo "uhh... nevermind"
